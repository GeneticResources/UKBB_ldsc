---
title: "UKBB ldsc $h^2$ Exploration"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(gap)
require(ggplot2)
load("dat.RData")
head(dat)
```
## Introduction

Explore results of univariate LD score regression for UKBB phenotypes. Liability-scale estimates of $h^2$ assume the population prevelence equals the sample prevelence in UKBB. Available below are:

* Phenotype lookup
* Histograms
* Scatter plots
* QQ plots



## Lookup a phenotype
```{r lookup, echo=FALSE}
inputPanel(
  selectInput("pheno", label = "Phenotype ID (type to search):",
              choices = dat$phenotype, selected = "50")
)

renderPrint({
	
	idx = which(dat$phenotype==input$pheno)

	base_str = '
	Phenotype: %s
	Mean chi2: %0.4f
	lambda GC: %0.4f
	Intercept: %0.4f (se=%.4g, p=%0.4e)
	Ratio: %0.4f
	Observed scale h2: %0.5f (se=%.4g, p=%0.4e)
	Liability scale h2: %0.5f (se=%.4g, p=%0.4e)
	'

	h2summ = sprintf(base_str,
				 dat$phenotype[idx],
				 dat$mean_chi2[idx],
				 dat$lambdaGC[idx],
				 dat$intercept[idx],
				 dat$intercept_se[idx],
				 dat$intercept_p[idx],
				 dat$ratio[idx],
				 dat$h2_observed[idx],
				 dat$h2_observed_se[idx],
				 dat$h2_p[idx],
				 dat$h2_liability[idx],
				 dat$h2_liability_se[idx],
				 dat$h2_p[idx])
			
	cat(h2summ)		
})

renderUI({
	phenstem = split(input$pheno, "_")[1]
	ukb_url = a("Find this phenotype on the UK Biobank Showcase", href=paste0("http://biobank.ctsu.ox.ac.uk/crystal/search.cgi?srch=",phenstem))
	
	tagList(ukb_url)
	})

```


## Histograms

Histograms of all the variables output from univariate LD score regression. For $z$-scores and $p$-values, the expected distribution under the null is plotted in blue.

```{r hists, echo=FALSE}
inputPanel(
  selectInput("varname", label = "Variable:",
              choices = names(dat)[-1], selected = "intercept"),
  
  sliderInput("nbreaks", label = "Number of bins:",
              min = 10, max = 200, value = 100, step = 5)
)

renderPlot({
  hist(dat[,input$varname], freq = FALSE, breaks = as.numeric(input$nbreaks),
       xlab = input$varname, main = "",
  	 cex.lab=1.4)
  nc = nchar(input$varname)
  if(substring(input$varname, nc-1, nc)=="_z"){
  	qq <- seq(-20,20,.1)
  	dens <- dnorm(qq)
  	lines(qq, dens, col = "blue", lwd=2)
  }
  else if(substring(input$varname, nc-1, nc)=="_p"){
  	qq <- seq(0,1,.005)
  	dens <- dunif(qq)
  	lines(qq, dens, col = "blue")
  }
})

```

## Scatter Plots

Scatter plots for any pair of variables. Click on a point to get full results for that phenotype.

```{r scatter, echo=FALSE}
inputPanel(
  selectInput("xname", label = "x-axis variable:",
              choices = names(dat)[-1], selected = "intercept"),
  
  selectInput("yname", label = "y-axis variable:",
              choices = names(dat)[-1], selected = "h2_observed")
)


renderUI({
   plotOutput(
      'scatter1',
      click = 'Click1'
   )
})

output[['scatter1']] <- renderPlot({
	ggplot(dat, aes_string(input$xname,input$yname))+geom_point(size=3)+theme(axis.title=element_text(size=16))
})

renderPrint({
	
	cat("Click point for more info.\n")
	
	datrow = nearPoints(dat, input$Click1, xvar=input$xname, yvar=input$yname)


	base_str = '
	Phenotype: %s
	Mean chi2: %0.4f
	lambda GC: %0.4f
	Intercept: %0.4f (se=%.4g, p=%0.4e)
	Ratio: %0.4f
	Observed scale h2: %0.5f (se=%.4g, p=%0.4e)
	Liability scale h2: %0.5f (se=%.4g, p=%0.4e)
	'

	h2summ = sprintf(base_str,
				 datrow$phenotype,
				 datrow$mean_chi2,
				 datrow$lambdaGC,
				 datrow$intercept,
				 datrow$intercept_se,
				 datrow$intercept_p,
				 datrow$ratio,
				 datrow$h2_observed,
				 datrow$h2_observed_se,
				 datrow$h2_p,
				 datrow$h2_liability,
				 datrow$h2_liability_se,
				 datrow$h2_p)			
	cat(h2summ)		
})


```

## QQ plots

QQ plots for tests of the intercept and heritability estimates.

```{r qq, echo=FALSE}
inputPanel(
  selectInput("qqname", label = "Variable:",
              choices = c("intercept_p","h2_p"), selected = "intercept_p"))

renderPlot({
  qqunif(dat[,input$qqname], ci=TRUE, alpha=0.01, col="black", cex.lab=1.4)
})

```






